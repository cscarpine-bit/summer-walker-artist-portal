name: Deploy Flutter Web to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.1'
          channel: 'stable'
      
      - name: Enable web
        run: flutter config --enable-web
      
      - name: Flutter doctor
        run: flutter doctor -v
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Clean build
        run: flutter clean
      
      - name: Build web with verbose output
        run: |
          echo "🔍 Building Flutter web app..."
          flutter build web --release --base-href /summer-walker-artist-portal/ --verbose
          echo "🎉 Build completed!"
      
      - name: Verify build files
        run: |
          echo "🔍 Checking build output..."
          ls -la build/web/
          echo "📁 Checking critical files..."
          if [ -f "build/web/flutter_bootstrap.js" ]; then
            echo "✅ flutter_bootstrap.js exists"
            ls -la "build/web/flutter_bootstrap.js"
          else
            echo "❌ flutter_bootstrap.js missing!"
            echo "🔍 Looking for similar files..."
            find build/web/ -name "*bootstrap*" -o -name "*flutter*" | head -10
            echo "🔍 Checking if this is a Flutter version issue..."
            flutter --version
            exit 1
          fi
          if [ -f "build/web/main.dart.js" ]; then
            echo "✅ main.dart.js exists"
          else
            echo "❌ main.dart.js missing!"
            exit 1
          fi
          if [ -f "build/web/flutter.js" ]; then
            echo "✅ flutter.js exists"
          else
            echo "❌ flutter.js missing!"
            exit 1
          fi
          echo "🎉 All critical files present!"
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
          force_orphan: true
      
      - name: Verify deployment
        run: |
          echo "🌐 Waiting for deployment to complete..."
          sleep 30
          echo "🔍 Checking deployed files..."
          curl -f "https://cscarpine-bit.github.io/summer-walker-artist-portal/flutter_bootstrap.js" || echo "❌ flutter_bootstrap.js not accessible"
          curl -f "https://cscarpine-bit.github.io/summer-walker-artist-portal/main.dart.js" || echo "❌ main.dart.js not accessible"
          curl -f "https://cscarpine-bit.github.io/summer-walker-artist-portal/flutter.js" || echo "❌ flutter.js not accessible"
          echo "🎯 Deployment verification complete!"
